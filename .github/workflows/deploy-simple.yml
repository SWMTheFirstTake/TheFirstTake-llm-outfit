# # name: Deploy to EC2 (Simple)

# # on:
# #   push:
# #     branches: [ main ]

# # jobs:
# #   test:
# #     runs-on: ubuntu-latest
    
# #     steps:
# #     - uses: actions/checkout@v4
    
# #     - name: Set up Python
# #       uses: actions/setup-python@v4
# #       with:
# #         python-version: '3.11'
    
# #     - name: Install dependencies
# #       run: |
# #         python -m pip install --upgrade pip
# #         pip install -r requirements.txt
    
# #     - name: Run tests
# #       run: |
# #         echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
# #         # python -m pytest

# #   deploy:
# #     needs: test
# #     runs-on: ubuntu-latest
# #     if: github.ref == 'refs/heads/main'
    
# #     steps:
# #     - uses: actions/checkout@v4
    
# #     - name: Deploy to EC2
# #       uses: appleboy/ssh-action@v1.0.0
# #       with:
# #         host: ${{ secrets.LLM_OUTFIT_EC2_HOST }}
# #         username: ${{ secrets.LLM_OUTFIT_EC2_USERNAME }}
# #         key: ${{ secrets.LLM_OUTFIT_EC2_SSH_KEY }}
# #         script: |
# #           echo "ðŸš€ TheFirstTake LLM Outfit API ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
# #            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì„¤ì •
# #           PROJECT_DIR="/home/ubuntu/TheFirstTake-llm-outfit-api"
          
# #           if [ ! -d "$PROJECT_DIR" ]; then
# #             echo "ðŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ë¦¬í¬ì§€í† ë¦¬ë¥¼ cloneí•©ë‹ˆë‹¤..."
# #             mkdir -p $PROJECT_DIR && cd $PROJECT_DIR
# #             git clone https://github.com/SWMTheFirstTake/TheFirstTake-llm-outfit.git .
# #           else
# #             echo "ðŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤..."
# #             cd $PROJECT_DIR
# #             git pull origin main
# #           fi
          
# #           # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
# #           if [ ! -d "venv" ]; then
# #             echo "ðŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
# #             python3 -m venv venv
# #           fi
          
# #           # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
# #           source venv/bin/activate
# #           pip install --upgrade pip
# #           pip install -r requirements.txt
          
# #           # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
# #           echo "ðŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
# #           sudo systemctl stop llm-outfit-api 2>/dev/null || true
# #           pkill -f "uvicorn main:app" 2>/dev/null || true
          
# #           # ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
# #           echo "âš™ï¸ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
# #           sudo tee /etc/systemd/system/llm-outfit-api.service > /dev/null <<EOF
# #           [Unit]
# #           Description=TheFirstTake LLM Outfit API
# #           After=network.target
          
# #           [Service]
# #           Type=simple
# #           User=ubuntu
# #           WorkingDirectory=/home/ubuntu/llm-outfit-api
# #           Environment=PATH=/home/ubuntu/llm-outfit-api/venv/bin
# #           Environment=ENVIRONMENT=production
# #           Environment=DEBUG=False
# #           Environment=LLM_API_HOST=0.0.0.0
# #           Environment=LLM_API_PORT=6020
# #           Environment=LOG_LEVEL=INFO
# #           ExecStart=/home/ubuntu/llm-outfit-api/venv/bin/uvicorn main:app --host 0.0.0.0 --port 6020
# #           Restart=always
# #           RestartSec=10
          
# #           [Install]
# #           WantedBy=multi-user.target
# #           EOF
          
# #           # ì„œë¹„ìŠ¤ ë“±ë¡ ë° ì‹œìž‘
# #           echo "ðŸš€ ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
# #           sudo systemctl daemon-reload
# #           sudo systemctl enable llm-outfit-api
# #           sudo systemctl start llm-outfit-api
          
# #           # ë°°í¬ í™•ì¸
# #           echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
# #           echo "ðŸ“ ì„œë²„ ì£¼ì†Œ: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020"
# #           echo "ðŸ” í—¬ìŠ¤ ì²´í¬: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020/health"
          
# #           # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
# #           sudo systemctl status llm-outfit-api --no-pager 
# name: Deploy to EC2 (Simple)

# on:
#   push:
#     branches: [ main ]

# jobs:
#   test:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: '3.11'
    
#     - name: Install dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt
    
#     - name: Run tests
#       run: |
#         echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
#         # python -m pytest

#   deploy:
#     needs: test
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main'
    
#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Deploy to EC2
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#         host: ${{ secrets.LLM_OUTFIT_EC2_HOST }}
#         username: ${{ secrets.LLM_OUTFIT_EC2_USERNAME }}
#         key: ${{ secrets.LLM_OUTFIT_EC2_SSH_KEY }}
#         script: |
#           echo "ðŸš€ TheFirstTake LLM Outfit API ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          
#           # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì„¤ì •
#           PROJECT_DIR="/home/ubuntu/TheFirstTake-llm-outfit"
          
#           if [ ! -d "$PROJECT_DIR" ]; then
#             echo "ðŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ë¦¬í¬ì§€í† ë¦¬ë¥¼ cloneí•©ë‹ˆë‹¤..."
#             git clone https://github.com/SWMTheFirstTake/TheFirstTake-llm-outfit.git
#             cd $PROJECT_DIR
#           else
#             echo "ðŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤..."
#             cd $PROJECT_DIR
#             git pull origin main
#           fi
          
#           # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
#           if [ ! -d "venv" ]; then
#             echo "ðŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
#             python3 -m venv venv
#           fi
          
#           # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
#           source venv/bin/activate
#           pip install --upgrade pip
#           pip install -r requirements.txt
          
#           # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env íŒŒì¼ ìƒì„±)
#           echo "ðŸ” í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
#           cat > .env <<EOF
#           OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
#           CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}
#           REDIS_HOST=${{ secrets.REDIS_HOST }}
#           REDIS_PORT=${{ secrets.REDIS_PORT }}
#           ENVIRONMENT=production
#           DEBUG=False
#           LLM_API_HOST=0.0.0.0
#           LLM_API_PORT=6020
#           LOG_LEVEL=INFO
#           EOF
          
#           # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆìƒ ì¤‘ìš”)
#           chmod 600 .env

#           echo "ðŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
#           # í¬íŠ¸ ê¸°ë°˜ ì •ë¦¬ (ì•ˆì „í•¨)
#           echo "í¬íŠ¸ 6020 ì •ë¦¬ ì¤‘..."
#           lsof -ti:6020 | xargs -r kill -TERM 2>/dev/null || true
#           sleep 3

#           # systemctlë„ ì´ì œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
#           if sudo systemctl is-active --quiet llm-outfit-api; then
#               sudo systemctl stop llm-outfit-api
#               sleep 3
#           fi
#           # echo "1ë‹¨ê³„: í˜„ìž¬ í”„ë¡œì„¸ìŠ¤ ëª©ë¡ í™•ì¸"
#           # ps aux | grep uvicorn | head -5

#           # echo "2ë‹¨ê³„: í¬íŠ¸ ì‚¬ìš© ìƒí™© í™•ì¸"
#           # netstat -tlnp | grep 6020 || echo "í¬íŠ¸ 6020 ì‚¬ìš© ì•ˆí•¨"

#           # echo "3ë‹¨ê³„: lsofë¡œ ì •ë¦¬"
#           # lsof -ti:6020 | head -5 || echo "lsof ê²°ê³¼ ì—†ìŒ"

#           # echo "4ë‹¨ê³„: ì‹¤ì œ ì •ë¦¬ ì‹¤í–‰"
#           # lsof -ti:6020 | xargs -r kill -TERM 2>/dev/null || echo "kill ëª…ë ¹ì–´ ì™„ë£Œ"

#           # echo "âœ… ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ"
          
#           # ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
#           echo "âš™ï¸ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
#           sudo tee /etc/systemd/system/llm-outfit-api.service > /dev/null <<EOF
#           [Unit]
#           Description=TheFirstTake LLM Outfit API
#           After=network.target
          
#           [Service]
#           Type=simple
#           User=ubuntu
#           WorkingDirectory=$PROJECT_DIR
#           Environment=PATH=$PROJECT_DIR/venv/bin
#           Environment=ENVIRONMENT=production
#           Environment=DEBUG=False
#           Environment=LLM_API_HOST=0.0.0.0
#           Environment=LLM_API_PORT=6020
#           Environment=REDIS_HOST=${{ secrets.REDIS_HOST }}
#           Environment=REDIS_PORT=${{ secrets.REDIS_PORT }}
#           Environment=LOG_LEVEL=INFO
#           ExecStart=$PROJECT_DIR/venv/bin/uvicorn main:app --host 0.0.0.0 --port 6020
#           Restart=always
#           RestartSec=10
          
#           [Install]
#           WantedBy=multi-user.target
#           EOF
          
#           # ì„œë¹„ìŠ¤ ë“±ë¡ ë° ì‹œìž‘
#           echo "ðŸš€ ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
#           sudo systemctl daemon-reload
#           sudo systemctl enable llm-outfit-api
#           sudo systemctl start llm-outfit-api
          
#           # ë°°í¬ í™•ì¸
#           echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
#           echo "ðŸ“ ì„œë²„ ì£¼ì†Œ: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020"
          
#           # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
#           sudo systemctl status llm-outfit-api --no-pager
name: Deploy to EC2 (Fixed)

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        # python -m pytest

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LLM_OUTFIT_EC2_HOST }}
        username: ${{ secrets.LLM_OUTFIT_EC2_USERNAME }}
        key: ${{ secrets.LLM_OUTFIT_EC2_SSH_KEY }}
        script: |
          echo "ðŸš€ TheFirstTake LLM Outfit API ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          
          # í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •
          PROJECT_DIR="/home/ubuntu/TheFirstTake-llm-outfit"
          REPO_URL="https://github.com/SWMTheFirstTake/TheFirstTake-llm-outfit.git"
          
          # ê¸°ì¡´ ë””ë ‰í† ë¦¬ê°€ ìžˆìœ¼ë©´ ì™„ì „ ì‚­ì œ í›„ ìƒˆë¡œ clone (í™•ì‹¤í•œ ì—…ë°ì´íŠ¸)
          if [ -d "$PROJECT_DIR" ]; then
            echo "ðŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
            rm -rf "$PROJECT_DIR"
          fi
          
          # ìƒˆë¡œ clone
          echo "ðŸ“ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ìƒˆë¡œ cloneí•©ë‹ˆë‹¤..."
          git clone "$REPO_URL"
          cd "$PROJECT_DIR"
          
          # í˜„ìž¬ commit í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ðŸ“‹ í˜„ìž¬ commit ì •ë³´:"
          git log --oneline -3
          echo "ðŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(git log -1 --format=%cd)"
          
          # Python ê°€ìƒí™˜ê²½ ìƒì„±
          echo "ðŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          python3 -m venv venv
          
          # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (.env íŒŒì¼ ìƒì„±)
          echo "ðŸ” í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
          cat > .env <<EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_PORT=${{ secrets.REDIS_PORT }}
          ENVIRONMENT=production
          DEBUG=False
          LLM_API_HOST=0.0.0.0
          LLM_API_PORT=6020
          LOG_LEVEL=INFO
          EOF
          
          # .env íŒŒì¼ ê¶Œí•œ ì„¤ì •
          chmod 600 .env
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì™„ì „ ì¢…ë£Œ
          echo "ðŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì™„ì „ížˆ ì¤‘ì§€í•©ë‹ˆë‹¤..."
          
          # systemctlë¡œ ì„œë¹„ìŠ¤ ì •ì§€
          sudo systemctl stop llm-outfit-api 2>/dev/null || true
          
          # í¬íŠ¸ 6020 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          echo "í¬íŠ¸ 6020 ì •ë¦¬ ì¤‘..."
          sudo lsof -ti:6020 | xargs -r sudo kill -9 2>/dev/null || true
          
          # uvicorn í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          sudo pkill -9 -f "uvicorn.*main:app" 2>/dev/null || true
          
          # ìž ì‹œ ëŒ€ê¸°
          sleep 5
          
          # í¬íŠ¸ í™•ì¸
          if lsof -ti:6020 >/dev/null 2>&1; then
            echo "âš ï¸  ê²½ê³ : í¬íŠ¸ 6020ì´ ì—¬ì „ížˆ ì‚¬ìš© ì¤‘ìž…ë‹ˆë‹¤"
            lsof -i:6020
          else
            echo "âœ… í¬íŠ¸ 6020ì´ ê¹¨ë—í•©ë‹ˆë‹¤"
          fi
          
          # ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
          echo "âš™ï¸ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          sudo tee /etc/systemd/system/llm-outfit-api.service > /dev/null <<EOF
          [Unit]
          Description=TheFirstTake LLM Outfit API
          After=network.target
          
          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=$PROJECT_DIR
          Environment=PATH=$PROJECT_DIR/venv/bin
          EnvironmentFile=$PROJECT_DIR/.env
          ExecStart=$PROJECT_DIR/venv/bin/uvicorn main:app --host 0.0.0.0 --port 6020
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # ì„œë¹„ìŠ¤ ë“±ë¡ ë° ì‹œìž‘
          echo "ðŸš€ ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          sudo systemctl daemon-reload
          sudo systemctl enable llm-outfit-api
          sudo systemctl start llm-outfit-api
          
          # ì„œë¹„ìŠ¤ ì‹œìž‘ ëŒ€ê¸°
          sleep 10
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ðŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
          sudo systemctl status llm-outfit-api --no-pager
          
          # ë¡œê·¸ í™•ì¸
          echo "ðŸ“‹ ìµœê·¼ ë¡œê·¸:"
          sudo journalctl -u llm-outfit-api --no-pager -n 20
          
          # í¬íŠ¸ í™•ì¸
          echo "ðŸŒ í¬íŠ¸ 6020 ìƒíƒœ:"
          netstat -tlnp | grep 6020 || echo "í¬íŠ¸ 6020 í™•ì¸ ì•ˆë¨"
          
          # ìµœì¢… í™•ì¸
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ðŸ“ ì„œë²„ ì£¼ì†Œ: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020"
          
          # Health check ì‹œë„
          echo "ðŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œë„:"
          curl -f "http://localhost:6020/health" || echo "í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ì„œë¹„ìŠ¤ ì‹œìž‘ ì¤‘ì¼ ìˆ˜ ìžˆìŒ)"