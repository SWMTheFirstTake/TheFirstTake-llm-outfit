name: Deploy to EC2 (Simple)

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        # python -m pytest

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.LLM_OUTFIT_EC2_HOST }}
        username: ${{ secrets.LLM_OUTFIT_EC2_USERNAME }}
        key: ${{ secrets.LLM_OUTFIT_EC2_SSH_KEY }}
        script: |
          echo "ðŸš€ TheFirstTake LLM Outfit API ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
           # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì„¤ì •
          PROJECT_DIR="/home/ubuntu/llm-outfit-api"
          
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ðŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ë¦¬í¬ì§€í† ë¦¬ë¥¼ cloneí•©ë‹ˆë‹¤..."
            mkdir -p $PROJECT_DIR
          else
            echo "ðŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤..."
          fi

          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/llm-outfit-api
          
          # Gitì—ì„œ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git pull origin main
          
          # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
          if [ ! -d "venv" ]; then
            echo "ðŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
            python3 -m venv venv
          fi
          
          # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "ðŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
          sudo systemctl stop llm-outfit-api 2>/dev/null || true
          pkill -f "uvicorn main:app" 2>/dev/null || true
          
          # ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
          echo "âš™ï¸ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤..."
          sudo tee /etc/systemd/system/llm-outfit-api.service > /dev/null <<EOF
          [Unit]
          Description=TheFirstTake LLM Outfit API
          After=network.target
          
          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/llm-outfit-api
          Environment=PATH=/home/ubuntu/llm-outfit-api/venv/bin
          Environment=ENVIRONMENT=production
          Environment=DEBUG=False
          Environment=LLM_API_HOST=0.0.0.0
          Environment=LLM_API_PORT=6020
          Environment=LOG_LEVEL=INFO
          ExecStart=/home/ubuntu/llm-outfit-api/venv/bin/uvicorn main:app --host 0.0.0.0 --port 6020
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # ì„œë¹„ìŠ¤ ë“±ë¡ ë° ì‹œìž‘
          echo "ðŸš€ ì„œë¹„ìŠ¤ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."
          sudo systemctl daemon-reload
          sudo systemctl enable llm-outfit-api
          sudo systemctl start llm-outfit-api
          
          # ë°°í¬ í™•ì¸
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ðŸ“ ì„œë²„ ì£¼ì†Œ: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020"
          echo "ðŸ” í—¬ìŠ¤ ì²´í¬: http://${{ secrets.LLM_OUTFIT_EC2_HOST }}:6020/health"
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sudo systemctl status llm-outfit-api --no-pager 